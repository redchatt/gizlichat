<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BOSS CHAT | MOBILE READY</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        
        /* Dinamik ekran h√ºnd√ºrl√ºy√º (Mobil √º√ß√ºn …ôsas budur) */
        body { 
            background: #020617; 
            color: white; 
            font-family: sans-serif; 
            height: 100vh; 
            height: 100dvh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        canvas { position: fixed; top: 0; left: 0; z-index: -1; pointer-events: none; }
        
        /* Giri≈ü v…ô X…ôb…ôrdarlƒ±q Ekranƒ± */
        .box { background: rgba(15, 23, 42, 0.95); padding: 20px; border-radius: 20px; border: 2px solid #3b82f6; text-align: center; width: 90%; max-width: 320px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; }
        input[type="text"], input[type="password"] { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; background: #1e293b; color: white; border: 1px solid #334155; outline: none; }
        .btn { background: #3b82f6; color: white; border: none; padding: 12px; border-radius: 10px; width: 100%; font-weight: bold; cursor: pointer; }
        
        /* √áat Strukturu */
        .header { background: #1e293b; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #3b82f6; flex-shrink: 0; }
        
        #messages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            -webkit-overflow-scrolling: touch; 
        }
        
        .msg { padding: 10px 14px; border-radius: 15px; max-width: 85%; position: relative; color: white; font-size: 15px; }
        .me { align-self: flex-end; background: #3b82f6; border-bottom-right-radius: 2px; }
        .other { align-self: flex-start; background: #334155; border-bottom-left-radius: 2px; }
        
        .pfp { width: 38px; height: 38px; border-radius: 50%; border: 2px solid #3b82f6; object-fit: cover; }
        
        .footer { background: #0f172a; padding: 8px 10px; border-top: 1px solid #334155; flex-shrink: 0; }
        .row { display: flex; gap: 6px; align-items: center; }
        
        /* D√ºym…ôl…ôrin mobild…ô sƒ±ƒümasƒ± √º√ß√ºn √∂l√ß√ºl…ôr */
        .icon { font-size: 18px; background: #1e293b; width: 40px; height: 40px; border-radius: 50%; border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        #msgI { flex: 1; background: #1e293b; border: 1px solid #334155; color: white; padding: 10px 15px; border-radius: 20px; outline: none; font-size: 14px; }
        
        audio { height: 35px; width: 180px; margin-top: 5px; }
        .ts { font-size: 9px; display: block; text-align: right; margin-top: 4px; opacity: 0.6; }
        #reply-box { display: none; background: #1e293b; padding: 6px; border-left: 3px solid gold; margin-bottom: 5px; font-size: 11px; }
    </style>
</head>
<body>

<canvas id="bg"></canvas>

<div id="scr1" class="box">
    <h2 style="color:#3b82f6; margin-bottom:15px;">BOSS CHAT</h2>
    <input type="text" id="userInp" placeholder="Ad">
    <input type="password" id="passInp" placeholder="Kod">
    <button onclick="doLogin()" class="btn">DAXƒ∞L OL</button>
</div>

<div id="scr2" class="box" style="display:none; border-color:red;">
    <h2 style="color:red;">Dƒ∞QQ∆èT</h2>
    <p id="warnMsg" style="font-size:13px; margin-bottom:15px;"></p>
    <button onclick="doStart()" class="btn" style="background:red;">ANLADIM</button>
</div>
<div id="scr3" style="display:none; flex-direction:column; height:100%; width: 100%;">
    <div class="header">
        <div style="display:flex; align-items:center;">
            <label>
                <img id="myP" class="pfp" src="">
                <input type="file" id="pfpChange" style="display:none;" accept="image/*" onchange="updateMyPfp(this)">
            </label>
            <div style="margin-left:10px;">
                <b id="myN" style="font-size:14px;"></b>
                <div id="online" style="font-size:10px; color:#10b981;">Online: 0</div>
            </div>
        </div>
        <b onclick="location.reload()" style="color:red; cursor:pointer; font-size:12px;">√áIXI≈û</b>
    </div>

    <div id="messages"></div>

    <div class="footer">
        <div id="reply-box">
            <span id="reply-txt" style="color:gold;"></span>
            <span onclick="cancelReply()" style="float:right; color:red; cursor:pointer;">‚úï</span>
        </div>
        <div class="row">
            <label class="icon">üñºÔ∏è<input type="file" id="imgF" style="display:none;" onchange="sendImg(this)"></label>
            <button class="icon" id="vBtn">üé§</button>
            <input type="text" id="msgI" placeholder="Mesaj...">
            <button onclick="sendMsg()" class="icon" style="background:#3b82f6;">‚û§</button>
        </div>
    </div>
</div>

<script>
    var conf = {
        apiKey: "AIzaSyDzNOIEJfrKFGzrMzeT0Jaf6OCHBEq_LuA",
        databaseURL: "https://gizlichat-839ce-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "gizlichat-839ce"
    };
    if (!firebase.apps.length) firebase.initializeApp(conf);
    var db = firebase.database();
    var u, c, p, rep = null;
    var beep = new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3');

    function doLogin() {
        u = document.getElementById("userInp").value.trim();
        c = document.getElementById("passInp").value.trim();
        if(!u || !c) return;
        db.ref("users/" + c).once("value", function(s) {
            if(s.exists() && s.val().name === u) {
                p = s.val().pfp || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
                document.getElementById("warnMsg").innerText = "K…ônar ≈ü…ôxsl…ôri salmayƒ±n. Skrin payla≈üan PEYS∆èRDƒ∞R!";
                document.getElementById("scr1").style.display = "none";
                document.getElementById("scr2").style.display = "block";
            } else { alert("S…ôhv!"); }
        });
    }

    function doStart() {
        document.getElementById("scr2").style.display = "none";
        document.getElementById("scr3").style.display = "flex";
        document.getElementById("myN").innerText = u;
        document.getElementById("myP").src = p;
        
        var uRef = db.ref("users/" + c);
        uRef.child("online").set(true);
        uRef.onDisconnect().update({ online: false });

        db.ref("users").on("value", function(snap) {
            var count = 0;
            snap.forEach(function(x) { if(x.val().online) count++; });
            document.getElementById("online").innerText = "Online: " + count;
        });

        db.ref("users/" + c + "/pfp").on("value", function(s) {
            if(s.val()) { p = s.val(); document.getElementById("myP").src = p; }
        });

        var first = true;
        db.ref("messages").limitToLast(40).on("child_added", function(s) {
            drawMsg(s.val(), s.key);
            if(!first && s.val().n !== u) beep.play().catch(function(){});
        });
        db.ref("messages").once("value", function() { first = false; });
        db.ref("messages").on("child_removed", function(s) {
            var el = document.getElementById(s.key); if(el) el.remove();
        });
        initAudio();
    }

    function updateMyPfp(input) {
        var file = input.files[0]; if(!file) return;
        var r = new FileReader();
        r.onload = function(e) { db.ref("users/" + c).update({ pfp: e.target.result }); };
        r.readAsDataURL(file);
    }
    function getAzTime() {
        var d = new Date();
        return d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0');
    }

    function sendMsg() {
        var input = document.getElementById("msgI");
        if(!input.value.trim()) return;
        var data = { n: u, m: input.value, p: p, ts: getAzTime() };
        if(rep) { data.re = rep; cancelReply(); }
        db.ref("messages").push(data);
        input.value = "";
    }

    function drawMsg(d, k) {
        var box = document.getElementById("messages");
        var div = document.createElement("div");
        div.id = k; div.className = "msg " + (d.n === u ? "me" : "other");
        
        div.onclick = function() {
            rep = { u: d.n, t: (d.m || "Media").substring(0,20) };
            document.getElementById("reply-box").style.display = "block";
            document.getElementById("reply-txt").innerText = "Yanƒ±t: " + d.n;
        };
        
        div.oncontextmenu = function(e) {
            e.preventDefault();
            if(d.n === u && confirm("Silsin?")) db.ref("messages/" + k).remove();
        };

        var h = '<b style="font-size:10px;"><img src="'+d.p+'" style="width:18px;height:18px;border-radius:50%;vertical-align:middle;margin-right:5px;object-fit:cover;">'+d.n+'</b>';
        if(d.re) h += '<div style="background:rgba(0,0,0,0.1);padding:4px;font-size:10px;margin:5px 0;border-left:2px solid gold;">'+d.re.u+': '+d.re.t+'</div>';
        if(d.img) h += '<img src="'+d.img+'" style="width:100%;border-radius:10px;margin-top:5px;">';
        if(d.audio) h += '<audio src="'+d.audio+'" controls></audio>';
        if(d.m) h += '<div style="margin-top:5px;">'+d.m+'</div>';
        h += '<span class="ts">' + (d.ts || "") + '</span>';
        
        div.innerHTML = h;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function sendImg(input) {
        var file = input.files[0]; if(!file) return;
        var r = new FileReader();
        r.onload = function(e) { db.ref("messages").push({ n: u, p: p, img: e.target.result, ts: getAzTime() }); };
        r.readAsDataURL(file);
    }

    function initAudio() {
        var rec, ch = [];
        var b = document.getElementById("vBtn");
        b.onclick = function() {
            if(!rec || rec.state === "inactive") {
                navigator.mediaDevices.getUserMedia({ audio: true }).then(function(s) {
                    rec = new MediaRecorder(s); rec.start();
                    b.style.background = "red"; b.innerText = "‚èπÔ∏è";
                    rec.ondataavailable = function(e) { ch.push(e.data); };
                    rec.onstop = function() {
                        var fr = new FileReader();
                        fr.onload = function(e) { db.ref("messages").push({ n: u, audio: e.target.result, p: p, ts: getAzTime() }); };
                        fr.readAsDataURL(new Blob(ch, { type: "audio/mp3" }));
                        ch = []; b.style.background = "#1e293b"; b.innerText = "üé§";
                        s.getTracks().forEach(function(t) { t.stop(); });
                    };
                });
            } else { rec.stop(); }
        };
    }

    function cancelReply() { rep = null; document.getElementById("reply-box").style.display = "none"; }

    // Arxa fon Animasiyasƒ±
    var canvas = document.getElementById("bg");
    var ctx = canvas.getContext("2d");
    function setSize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.onresize = setSize; setSize();
    var dots = [];
    for(var i=0; i<20; i++) dots.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*3+2, v: Math.random()*0.5+0.1});
    function anim() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = "rgba(59,130,246,0.3)";
        dots.forEach(function(d) {
            d.y -= d.v; if(d.y < -10) d.y = canvas.height + 10;
            ctx.beginPath(); ctx.arc(d.x, d.y, d.r, 0, Math.PI*2); ctx.fill();
        });
        requestAnimationFrame(anim);
    }
    anim();
</script>
</body>
</html>
