<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GÄ°ZLÄ° Ã‡AT | ULTIMATE</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { background: #020617; color: white; font-family: sans-serif; height: 100vh; overflow: hidden; }
        #bg-canvas { position: fixed; top: 0; left: 0; z-index: -1; pointer-events: none; }
        
        /* YanÄ±tlama Paneli (Input-un Ã¼stÃ¼ndÉ™) */
        #reply-preview { display: none; background: #1e293b; padding: 10px; border-left: 4px solid #3b82f6; border-top: 1px solid #334155; position: absolute; bottom: 70px; width: 100%; z-index: 5; }
        
        /* SÃ¼rÃ¼ÅŸdÃ¼rmÉ™ AnimasiyasÄ± Ã¼Ã§Ã¼n */
        .msg-container { display: flex; align-items: center; width: 100%; transition: transform 0.2s ease; position: relative; }
        .reply-icon-swipe { position: absolute; left: -40px; font-size: 20px; color: #3b82f6; opacity: 0; }

        .msg-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 120px; }
        .msg { padding: 10px 14px; border-radius: 18px; max-width: 80%; position: relative; display: flex; flex-direction: column; cursor: pointer; }
        .msg.me { align-self: flex-end; background: #3b82f6; border-bottom-right-radius: 4px; }
        .msg.other { align-self: flex-start; background: #334155; border-bottom-left-radius: 4px; }
        
        /* YanÄ±tlama (Reply) MesajÄ±n iÃ§indÉ™ */
        .replied-part { background: rgba(0,0,0,0.2); border-left: 3px solid #fff; padding: 5px; margin-bottom: 5px; border-radius: 4px; font-size: 12px; }

        .header { background: #1e293b; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #3b82f6; }
        .footer { position: fixed; bottom: 0; width: 100%; background: #0f172a; padding: 12px; z-index: 10; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #3b82f6; object-fit: cover; }
        .msg-time { font-size: 9px; align-self: flex-end; opacity: 0.7; margin-top: 5px; }
        .pfp-msg { width: 20px; height: 20px; border-radius: 50%; margin-right: 5px; }
        .icon-btn { font-size: 20px; background: #1e293b; width: 40px; height: 40px; border-radius: 50%; border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        #warning-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 9999; }
    </style>
</head>
<body>

<canvas id="bg-canvas"></canvas>

<div id="warning-modal">
    <div style="background: #1e293b; border: 2px solid #ef4444; padding: 25px; border-radius: 20px; text-align: center; max-width: 350px;">
        <h2 style="color:#ef4444">DÄ°QQÆT â€¼ï¸</h2>
        <p style="margin: 20px 0;">Sayta kÉ™nar ÅŸÉ™xs soxmayÄ±n.<br>Ã‡Ä±xÄ±ÅŸ edÉ™ndÉ™ saÄŸdakÄ± "Ã‡IXIÅ" dÃ¼ymÉ™sini basÄ±n.</p>
        <button onclick="acceptWarning()" style="background:#ef4444; color:white; padding:12px 30px; border:none; border-radius:10px; font-weight:bold; width:100%;">ANLADIM</button>
    </div>
</div>

<div id="login-screen">
    <div style="background: rgba(30, 41, 59, 0.95); padding: 30px; border-radius: 20px; border: 2px solid #3b82f6; text-align: center; width: 90%; max-width: 320px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
        <h2 style="color:#3b82f6; margin-bottom:15px;">GÄ°RÄ°Å</h2>
        <input type="text" id="loginUser" placeholder="Ad" style="width:100%; padding:10px; margin-bottom:10px; background:#0f172a; border:1px solid #334155; color:white;">
        <input type="password" id="loginPass" placeholder="Kod" style="width:100%; padding:10px; margin-bottom:10px; background:#0f172a; border:1px solid #334155; color:white;">
        <button onclick="enterChat()" style="background:#3b82f6; color:white; border:none; padding:12px; border-radius:10px; width:100%; font-weight:bold;">DAXÄ°L OL</button>
    </div>
</div>

<div id="chat-screen" style="display:none; flex-direction:column; height:100vh;">
    <div class="header">
        <div style="display:flex; align-items:center;">
            <img id="myAvatar" src="" class="avatar">
            <div style="margin-left:12px;">
                <b id="uName">...</b>
                <div id="onlineStatus" style="font-size:10px; color:#10b981;">Online: 0</div>
            </div>
        </div>
        <b onclick="location.reload()" style="color:#ef4444; cursor:pointer;">Ã‡IXIÅ</b>
    </div>
    
    <div id="messages" class="msg-area"></div>

    <div id="reply-preview">
        <div style="display:flex; justify-content:space-between;">
            <div id="reply-text" style="font-size:12px; color:#3b82f6;"></div>
            <span onclick="cancelReply()" style="color:#ef4444; cursor:pointer; font-weight:bold;">âœ•</span>
        </div>
    </div>

    <div class="footer">
        <div style="display:flex; gap:10px; align-items:center;">
            <label class="icon-btn" for="imgInput">ğŸ–¼ï¸</label>
            <input type="file" id="imgInput" style="display:none;" onchange="sendMedia('img', this)">
            <button class="icon-btn" id="voiceBtn">ğŸ¤</button>
            <input type="text" id="msgInput" placeholder="Mesaj yazÄ±n..." style="flex:1; padding:10px; background:#1e293b; border:1px solid #334155; color:white; border-radius:10px;">
            <button onclick="sendMsg()" class="icon-btn" style="background:#3b82f6;">â¤</button>
        </div>
    </div>
</div>

<script>
    var config = {
        apiKey: "AIzaSyDzNOIEJfrKFGzrMzeT0Jaf6OCHBEq_LuA",
        authDomain: "gizlichat-839ce.firebaseapp.com",
        databaseURL: "https://gizlichat-839ce-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "gizlichat-839ce"
    };
    firebase.initializeApp(config);
    var db = firebase.database();
    var myName, myCode, myPic, currentReply = null;

    function enterChat() {
        var u = document.getElementById("loginUser").value.trim();
        var p = document.getElementById("loginPass").value.trim();
        db.ref("users/" + p).once("value", function(s) {
            if(s.exists() && s.val().name === u) {
                myName = u; myCode = p;
                myPic = s.val().pfp || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
                document.getElementById("warning-modal").style.display = "flex";
            } else { alert("SÉ™hvdir!"); }
        });
    }

    function acceptWarning() {
        document.getElementById("warning-modal").style.display = "none";
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("chat-screen").style.display = "flex";
        startSession();
    }

    function startSession() {
        document.getElementById("uName").innerText = myName;
        document.getElementById("myAvatar").src = myPic;
        
        db.ref("users/" + myCode).child("online").set(true);
        db.ref("users/" + myCode).child("online").onDisconnect().set(false);

        // YazÄ±r... vÉ™ Online sayÄŸacÄ±
        var input = document.getElementById("msgInput");
        input.oninput = () => {
            db.ref("users/" + myCode).update({ typing: true });
            clearTimeout(window.tT);
            window.tT = setTimeout(() => db.ref("users/" + myCode).update({ typing: false }), 2000);
        };
        db.ref("users").on("value", snap => {
            var count = 0, typers = [];
            snap.forEach(u => {
                if(u.val().online) count++;
                if(u.val().typing && u.key !== myCode) typers.push(u.val().name);
            });
            document.getElementById("onlineStatus").innerText = typers.length > 0 ? typers.join(",") + " yazÄ±r..." : "Online: " + count;
        });

        db.ref("messages").limitToLast(50).on("child_added", s => renderMsg(s.val(), s.key));
        db.ref("messages").on("child_removed", s => document.getElementById(s.key)?.remove());
    }

    function sendMsg() {
        var m = document.getElementById("msgInput").value.trim();
        if(!m) return;
        var data = { n: myName, m: m, p: myPic, ts: Date.now() };
        if(currentReply) { data.reply = currentReply; cancelReply(); }
        db.ref("messages").push(data);
        document.getElementById("msgInput").value = "";
    }

    function renderMsg(d, key) {
        var area = document.getElementById("messages");
        var container = document.createElement("div");
        container.className = "msg-container";
        container.id = key;

        var msgDiv = document.createElement("div");
        msgDiv.className = "msg " + (d.n === myName ? "me" : "other");

        // SÃ¼rÃ¼ÅŸdÃ¼rÃ¼b yanÄ±tlama (Swipe Logic)
        let startX = 0;
        msgDiv.ontouchstart = (e) => startX = e.touches[0].clientX;
        msgDiv.ontouchmove = (e) => {
            let diff = e.touches[0].clientX - startX;
            if(diff > 50 && diff < 100) {
                msgDiv.style.transform = translateX(${diff}px);
                if(diff > 70) setReply(d.n, d.m);
            }
        };
        msgDiv.ontouchend = () => msgDiv.style.transform = "translateX(0)";
        
        // Uzun basanda sil (Ã–z mesajÄ±nsa)
        msgDiv.oncontextmenu = (e) => {
            e.preventDefault();
            if(d.n === myName && confirm("HÉ™r kÉ™sdÉ™n silinsin?")) db.ref("messages/" + key).remove();
        };

        var html = <b><img src="${d.p}" class="pfp-msg">${d.n}</b>;
        if(d.reply) html += <div class="replied-part"><b>${d.reply.user}</b>: ${d.reply.text}</div>;
        html += <span>${d.m || (d.img ? "ğŸ–¼ï¸ ÅÉ™kil" : "ğŸ¤ SÉ™s")}</span>;
        if(d.img) html += <img src="${d.img}" style="width:100%; border-radius:10px; margin-top:5px;">;
        
        var date = new Date(d.ts);
        html += <span class="msg-time">${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}</span>;
        
        msgDiv.innerHTML = html;
        container.appendChild(msgDiv);
        area.appendChild(container);
        area.scrollTop = area.scrollHeight;
    }

    function setReply(user, text) {
        currentReply = { user: user, text: text.substring(0,30) };
        document.getElementById("reply-preview").style.display = "block";
        document.getElementById("reply-text").innerText = user + ": " + currentReply.text;
        document.getElementById("msgInput").focus();
    }

    function cancelReply() {
        currentReply = null;
        document.getElementById("reply-preview").style.display = "none";
    }

    function sendMedia(type, input) {
        var file = input.files[0];
        var r = new FileReader();
        r.onload = e => db.ref("messages").push({ n: myName, p: myPic, ts: Date.now(), [type]: e.target.result });
        r.readAsDataURL(file);
    }
</script>
</body>
</html>
